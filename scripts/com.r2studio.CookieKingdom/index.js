pageInputAge = [
  {x: 296, y: 214, r: 253, g: 204, b: 176},
  {x: 248, y: 279, r: 254, g: 94, b: 0},
  {x: 280, y: 273, r: 254, g: 94, b: 0},
  {x: 345, y: 276, r: 254, g: 94, b: 0},
  {x: 400, y: 280, r: 254, g: 94, b: 0},
]

pageConfirmTerms = [
  {x: 179, y: 214, r: 255, g: 255, b: 255},
  {x: 312, y: 217, r: 255, g: 255, b: 255},
  {x: 419, y: 198, r: 255, g: 255, b: 255},
  {x: 427, y: 138, r: 255, g: 255, b: 255},
]

pageDownloadNewData = [
  {x: 291, y: 244, r: 121, g: 207, b: 15},
  {x: 352, y: 241, r: 121, g: 207, b: 12},
  {x: 302, y: 99, r: 60, g: 70, b: 105},
  {x: 402, y: 165, r: 243, g: 233, b: 223},
]

pageChooseAccount = [
  {x: 377, y: 109, r: 255, g: 255, b: 255},
  {x: 380, y: 145, r: 255, g: 255, b: 255},
  {x: 382, y: 187, r: 255, g: 255, b: 255},
  {x: 380, y: 222, r: 255, g: 255, b: 255},
  {x: 250, y: 143, r: 0, g: 1, b: 0},
  {x: 248, y: 181, r: 66, g: 103, b: 178}
]

pageSkipBtn = [
  // {x: 567, y: 27, r: 51, g: 27, b: 22},
  // {x: 605, y: 25, r: 29, g: 29, b: 29},
  {x: 570, y: 31, r: 109, g: 175, b: 216}
]

pageInBattle = [
  {x: 561, y: 335, r: 179, g: 163, b: 143},
  {x: 585, y: 312, r: 255, g: 241, b: 235},
  {x: 582, y: 287, r: 255, g: 241, b: 235}
]

pageInputKingdomName = [
  {x: 390, y: 163, r: 255, g: 255, b: 255},
  {x: 251, y: 120, r: 60, g: 70, b: 105},
  {x: 409, y: 204, r: 243, g: 233, b: 223},
  {x: 422, y: 245, r: 219, g: 207, b: 199},
  {x: 364, y: 236, r: 160, g: 160, b: 160},
]

pageKingdomStory = [
  {x: 555, y: 93, r: 56, g: 169, b: 231},
  {x: 597, y: 150, r: 190, g: 80, b: 60},
  {x: 505, y: 107, r: 178, g: 50, b: 32},
  {x: 544, y: 125, r: 48, g: 68, b: 109},
  {x: 541, y: 164, r: 255, g: 251, b: 235},
]

pageFirstBattleMission = [
  {x: 303, y: 177, r: 227, g: 229, b: 228},
  {x: 323, y: 175, r: 252, g: 198, b: 1},
  {x: 325, y: 188, r: 204, g: 209, b: 205},
  {x: 617, y: 147, r: 56, g: 20, b: 15}
]

//First battle does not have 3 stars
// pageFirstBattleIsWon = [
//     {x: 225, y: 83, r: 48, g: 135, b: 211},
//     {x: 390, y: 84, r: 52, g: 137, b: 215}
// ]

pageBattleIsWon = [
  // victory flag
  // {x: 225, y: 83, r: 48, g: 135, b: 211},
  // {x: 390, y: 84, r: 52, g: 137, b: 215},

  // lower right leave button
  {x: 564, y: 326, r: 12, g: 165, b: 219},
  {x: 611, y: 324, r: 12, g: 165, b: 219}
]

pageLeaveBattle = [
  {x: 613, y: 327, r: 12, g: 165, b: 219},
  {x: 559, y: 320, r: 61, g: 183, b: 223}
]

pageLeftBattle = [
  {x: 321, y: 168, r: 130, g: 198, b: 8},
  {x: 318, y: 159, r: 42, g: 205, b: 0},
  {x: 318, y: 146, r: 206, g: 232, b: 97},
]

pageMakeCookie = [
  {x: 556, y: 319, r: 146, g: 80, b: 69},
  {x: 324, y: 216, r: 255, g: 243, b: 239},
  {x: 621, y: 146, r: 56, g: 20, b: 15},
]

pagePlayTrackCakeDog = [
  {x: 617, y: 326, r: 48, g: 80, b: 117},
  {x: 411, y: 263, r: 255, g: 243, b: 239},
  {x: 294, y: 204, r: 247, g: 112, b: 185}
]

// route page by checking hears, coins and diamon
pageInQuestRoutes = [
  {x: 617, y: 29, r: 70, g: 121, b: 172},
  {x: 585, y: 24, r: 247, g: 231, b: 207},
  {x: 458, y: 22, r: 8, g: 144, b: 255},
  {x: 354, y: 26, r: 238, g: 170, b: 0},
  {x: 282, y: 17, r: 240, g: 50, b: 93},
  {x: 62, y: 342, r: 42, g: 72, b: 106}
]

pageInVillate = [
  {x: 531, y: 316, r: 255, g: 255, b: 255},
  {x: 424, y: 21, r: 5, g: 141, b: 255},
  {x: 519, y: 20, r: 235, g: 161, b: 87},
  {x: 616, y: 326, r: 48, g: 80, b: 117},
]

// Look for red ! in the middle
pageHasQuestInMiddle = [
  //rgb(234, 235, 231), rgb(223, 226, 217), rgb(174, 209, 77)
  // {x: 307, y: 127, r: 234, g: 235, b: 231},
  // {x: 330, y: 128, r: 223, g: 226, b: 217},
  // {x: 309, y: 182, r: 214, g: 255, b: 58}
  {x: 311, y: 184, r: 213, g: 255, b: 76}
]
pageHasQuestInMiddle2 = [
  {x: 312, y: 202, r: 219, g: 255, b: 73}
]

pageHasNextQuest = [
  {x: 420, y: 329, r: 239, g: 242, b: 237},
  {x: 440, y: 331, r: 235, g: 237, b: 234},
  {x: 63, y: 342, r: 46, g: 76, b: 109}
]

pageHasNextQuest2 = [
  {x: 436, y: 333, r: 231, g: 234, b: 227},
  {x: 454, y: 331, r: 235, g: 237, b: 234}
]

pageHasMail = [
  {x: 551, y: 16, r: 238, g: 238, b: 238},
  {x: 558, y: 9, r: 255, g: 0, b: 0}
]

config = {
  sleep: 240,
  sleepAnimate: 800,

  chooseAccountAndLoginGame: false,
  finishBattles: 3,
  mailGet: false,
  run: true,
}

function pnt(x, y) {
  return {x: x, y: y};
}

function rgb(r, g, b) {
  return {r:r, g:g, b:b}
}

function qTap(page, sleepTime) {
  if (sleepTime == undefined) {
      sleepTime = config.sleep;
  }
  if (Array.isArray(page)) {
      page = page[0];
  }
  tap(page.x, page.y, sleepTime);
  sleep(sleepTime);
}

function isSameColor(c1, c2, diff) {
  if (diff === undefined) {
    diff = 35;
  }
  // console.log(JSON.stringify(c1), JSON.stringify(c2), diff);
  if (Math.abs(c1.r - c2.r) < diff && Math.abs(c1.g - c2.g) < diff && Math.abs(c1.b - c2.b) < diff) {
    return true;
  }
  return false;
}

function checkIsPage(page, diff, img) {
  var release = false;
  if (img === undefined) {
    img = getScreenshot();
    release = true;
  }
  var whSize = getImageSize(img);
  if (whSize.width === 360) {
    throw new Error('ROBroken');
  }
  var isPage = true;
  for (var i in page) {
    var cbtn = page[i];
    var color = getImageColor(img, cbtn.x, cbtn.y);
    if (!isSameColor(cbtn, color, diff)) {
      isPage = false;
      break;
    }
  }
  if (release) {
    releaseImage(img);
  }
  return isPage;
}

initGameCheckCnter = 0;
function handleInitGamePage() {
  initGameCheckCnter ++;
  if (config.chooseAccountAndLoginGame && initGameCheckCnter % 20 != 0) {
      return;
  }

  if (checkIsPage(pageInputAge)) {
      qTap(pageInputAge);
      qTap(pageInputAge[1]);
      return true;
  }

  if (checkIsPage(pageConfirmTerms)) {
      qTap([{x: 454, y: 221}]);
      return true;
  }

  if (checkIsPage(pageDownloadNewData)) {
      qTap(pageDownloadNewData);
      return true;
  }

  if (checkIsPage(pageChooseAccount)) {
      qTap([{x: 315, y: 264}]);
      qTap([{x: 315, y: 264}]);
      sleep(config.sleepAnimate);
      qTap([{x: 332, y: 329}]);
      qTap([{x: 332, y: 329}]);
      config.chooseAccountAndLoginGame = true;
      return true;
  }
}

function handleInBattle() {
  if (checkIsPage(pageInBattle)) {
      console.log("handleInBattle")
      qTap(pageInBattle);
      return true;
  }
  return false;
}

function handleInputKingdomName() {
  if (checkIsPage(pageInputKingdomName)) {
      console.log("handleInputKingdomName")

      pageNameConflict = [
          {x: 314, y: 106, r: 60, g: 70, b: 105},
          {x: 350, y: 246, r: 121, g: 207, b: 12},
          {x: 387, y: 249, r: 219, g: 207, b: 199}
      ]
      while(true)
      {
          qTap(pageInputKingdomName);

          // Double click to clear the kingdom name
          tap(27, 327, 20);
          tap(27, 327, 20);
  
          typing("Xookie" + Math.ceil(Math.random() * 10000), 10000);
          sleep(config.sleepAnimate*2);
          qTap([{x: 594, y: 322}]);
          qTap([{x: 329, y: 233}]); //check conflict
          sleep(config.sleepAnimate*2);
  
          if (!checkIsPage(pageNameConflict)) {
              qTap([{x: 372, y: 234}]);
              return true;
          }
      }
  }
  return false;
}

function handleBuildHouse() {
  pageToBuildHouse = [
      {x: 57, y: 342, r: 52, g: 86, b: 125},
      {x: 22, y: 331, r: 101, g: 40, b: 40},
      {x: 599, y: 151, r: 188, g: 80, b: 58}
  ]
  pageVilleageFullUI = [
      {x: 473, y: 324, r: 224, g: 150, b: 76},
      {x: 21, y: 116, r: 170, g: 0, b: 34}
  ]

  if (checkIsPage(pageToBuildHouse) &&!checkIsPage(pageVilleageFullUI)) {
      console.log("handleBuildHouse. pausing")
      // sleep(100000);
      qTap(pageToBuildHouse);
      sleep(config.sleepAnimate*2);
      qTap([pnt(112, 273)]);
      sleep(config.sleepAnimate*2);
      qTap([pnt(325, 299)]);
      sleep(config.sleepAnimate*2);
      qTap([pnt(389, 156)]);
      sleep(config.sleepAnimate*2);
      qTap([pnt(389, 156)]);
      sleep(config.sleepAnimate*2);
      qTap([pnt(329, 264)]);
      sleep(config.sleepAnimate*3);
      qTap([pnt(314, 197)]);
      qTap([pnt(314, 197)]);
      sleep(config.sleepAnimate*2);
      qTap([pnt(412, 161)]);
      qTap([pnt(412, 161)]);
      sleep(config.sleepAnimate*3);
      qTap([pnt(325, 262)]);
      qTap([pnt(325, 262)]);
      return true;
  }
  return false;
}

function handleBattle() {
  // click skills while in battle
  while (true) {
      //{x: 590, y: 12, r: 243, g: 38, b: 38}, rgb(243, 38, 38)
      if (checkIsPage(pageBattleIsWon)) {
          qTap(pageBattleIsWon);
          console.log("battle won!")
          break;
      }

      qTap(pnt(320, 332));
      qTap(pnt(251, 323));
      qTap(pnt(380, 323));
      qTap(pnt(464, 323));
      qTap(pnt(174, 323));    
  }

  // tap lower right blue leave battle btn
  while(!checkIsPage(pageLeaveBattle)) {
      qTap(pageLeaveBattle);
      console.log('wait 10s to leave battle')
      sleep(10000);
      config.finishBattles ++;
  }
}

function handleFirstBattleMisson() {
  if(checkIsPage(pageFirstBattleMission)) {
      console.log('handleFirstBattleMisson');
      qTap(pageFirstBattleMission);
      sleep(config.sleepAnimate);

      // todo: check page
      qTap(pnt(498, 321));
      qTap(pnt(543, 327));
      qTap(pnt(543, 327));

      handleBattle();
      sleep(5000);

      pageTapForest = [
          {x: 319, y: 169, r: 130, g: 197, b: 8},
          {x: 605, y: 322, r: 134, g: 18, b: 10},
          {x: 617, y: 150, r: 167, g: 59, b: 43}
      ];
      
      for (i = 0; i < 300; i ++) {
          console.log('get first battle reward: ', i);
          if (checkIsPage(pageTapForest)) {
              qTap(pageTapForest)
              break;
          }
          sleep(1000);
      }
      
      pageFirstBattleReward = [
          {x: 353, y: 263, r: 121, g: 207, b: 12},
          {x: 351, y: 116, r: 178, g: 50, b: 32},
          {x: 397, y: 125, r: 48, g: 68, b: 109}
      ]
      
      // tap finish forest
      for (i = 0; i < 5000; i ++) {
          console.log('tap first battle forest: ', i);
          if (checkIsPage(pageFirstBattleReward)) {
              qTap(pageFirstBattleReward)
              qTap(pnt(315, 261));
              qTap(pnt(320, 310));        
              break;
          }
          sleep(1000);
      }
      return true;
  }
  return false;
}

function handleCloseStoryDialog() {
  if (checkIsPage(pageKingdomStory)) {
      console.log("handleCloseStoryDialog")
      qTap(pageKingdomStory);
      return true;
  }
  return false;
}

function handleMakeCookie() {
  if (checkIsPage(pageMakeCookie)) {
      console.log("handleMakeCookie")
      qTap(pageMakeCookie);
      sleep(config.sleepAnimate*2);
      qTap(pnt(75, 132));
      qTap(pnt(449, 311));
      qTap(pnt(449, 311));
      qTap(pageSkipBtn);
      qTap(pageSkipBtn);
      sleep(config.sleepAnimate*2);
      qTap(pageSkipBtn);
      qTap(pageSkipBtn);

      // rgb(18,86,120), rgb(56,167,231)
      pageCloseFirstCookie = [
          // {x: 625, y: 20, r: 18, g: 86, b: 120}
          {x: 625, y: 19, r: 62, g: 164, b: 232},
          {x: 483, y: 316, r: 20, g: 61, b: 3}
      ];
      // sleep(15000);
      for (i = 0; i < 30; i ++ ) {
          console.log('checking first cookie: ', i)
          if (checkIsPage(pageCloseFirstCookie)) {
              qTap(pageCloseFirstCookie);
              sleep(config.sleepAnimate);
              qTap(pageCloseFirstCookie);
              sleep(config.sleepAnimate);
              qTap(pageCloseFirstCookie);
              break;
          }
          qTap(pageCloseFirstCookie);
          sleep(1000);
      }

      pageGetReword = [ {x: 320, y: 262, r: 52, g: 54, b: 49}];
      for (i = 0; i < 20; i ++ ) {
          if (checkIsPage(pageGetReword)) {
              qTap(pageGetReword);
              qTap(pageGetReword);
              break;
          }
          sleep(1000);
      }

      return true;
  }
  return false
}

function handlePlayTrackCakeDog() {
  if (checkIsPage(pagePlayTrackCakeDog)){
      console.log('pagePlayTrackCakeDog, pause');
      sleep(10000000);
      qTap(pagePlayTrackCakeDog);
      qTap(pnt(162, 164));
      qTap(pnt(162, 164));
      qTap(pnt(162, 164));
      qTap(pnt(162, 164));
      return true;
  }
  return false;
}

function handleGetAllMails() {
  if (config.mailGet) {
      return false;
  }

  if (checkIsPage(pageHasMail)) {
      console.log('pageHasMail')
      qTap(pageHasMail);
      qTap(pnt(548, 321));
      qTap(pnt(548, 321));

      pageCloseMailBox = [{x: 617, y: 19, r: 56, g: 167, b: 231}];
      for (i = 0; i < 60; i ++) {
          console.log('pageCloseMailBox: ', i)
          if (checkIsPage(pageCloseMailBox)) {
              qTap(pageCloseMailBox);
              break;
          }
          qTap(pageCloseMailBox);
          sleep(1000);             
      }

      config.mailGet = true;
      return true;
  }
  return false;
}

function handleMakeAllCookies() {
  if (checkIsPage(pageInVillate)) {
      qTap(pageInVillate);
      sleep(config.sleepAnimate * 2);
      qTap(pnt(171,181));
      sleep(config.sleepAnimate * 4);
  }

  pageCanMakeCookie = [
      {x: 442, y: 318, r: 146, g: 80, b: 69},
      {x: 427, y: 21, r: 6, g: 140, b: 255},
      {x: 622, y: 86, r: 65, g: 98, b: 138}
  ]
  if (checkIsPage(pageCanMakeCookie)) {
      console.log("pageCanMakeCookie, check mail first")
      handleGetAllMails();

      // tap make cookie
      qTap(pageCanMakeCookie);
      console.log('Start making cookies')

      // Use 3000 diamond
      for(var i = 0; i < 10; i ++ ) {
          console.log('making $3000 cookies: ', i)
          qTap(pnt(563, 303));
          sleep(config.sleepAnimate * 2);

          pageNotEnoughDiamond = [{x: 319, y: 182, r: 6, g: 130, b: 253}];
          if (checkIsPage(pageNotEnoughDiamond)) {
              qTap(pnt(436, 96));
              sleep(config.sleepAnimate);
              break;
          }
          qTap(pnt(365, 245));

          pageCanMakeOneCookie = [
              {x: 488, y: 315, r: 60, g: 181, b: 8}
          ]
          while(true) {
              if (checkIsPage(pageCanMakeOneCookie)) {
                  break;
              }
              console.log('keep pushing skip')
              qTap(pageSkipBtn);
              sleep(config.sleepAnimate);
          }
      }
      sleep(config.sleepAnimate);

      for(var i = 0; i < 30; i ++ ) {
          console.log('making normal cookies')
          qTap(pnt(439, 304));

          pageNotEnoughDiamond = [{x: 319, y: 182, r: 6, g: 130, b: 253}];
          if (checkIsPage(pageNotEnoughDiamond)) {
              qTap(pnt(436, 96));
              qTap(pnt(436, 96));
              sleep(config.sleepAnimate * 2);
              break;
          }

          pageCanMakeOneCookie = [
              {x: 488, y: 315, r: 60, g: 181, b: 8}
          ]
          pageMakingCookieSkip = [
              {x: 570, y: 31, r: 109, g: 175, b: 216}
          ]
          while(true) {
              if (checkIsPage(pageCanMakeOneCookie)) {
                  break;
              }
              console.log('keep pushing skip')
              qTap(pageMakingCookieSkip);
              sleep(config.sleepAnimate);
          }
      }

      pageCanMakeFreeCookie = [
          {x: 167, y: 123, r: 255, g: 0, b: 0}
      ]
      if (checkIsPage(pageCanMakeFreeCookie)) {
          qTap(pageCanMakeFreeCookie);
          sleep(config.sleepAnimate);
          
          for(var i = 0; i < 10; i ++ ) {
              console.log('making normal cookies')
              qTap(pnt(439, 304));
          
              pageNotEnoughDiamond = [{x: 319, y: 182, r: 6, g: 130, b: 253}];
              if (checkIsPage(pageNotEnoughDiamond)) {
                  qTap(pnt(436, 96));
                  qTap(pnt(436, 96));
                  sleep(config.sleepAnimate * 2);
                  break;
              }
          
              pageCanMakeOneCookie = [
                  {x: 488, y: 315, r: 60, g: 181, b: 8}
              ]
              pageMakingCookieSkip = [
                  {x: 570, y: 31, r: 109, g: 175, b: 216}
              ]
              while(true) {
                  sleep(2000)
                  if (checkIsPage(pageCanMakeOneCookie)) {
                      break;
                  }
                  console.log('keep pushing skip')
                  qTap(pageMakingCookieSkip);
                  sleep(config.sleepAnimate);
              }
          }
      }

      // leave
      qTap(pnt(620, 22));
      sleep(config.sleepAnimate);
      qTap(pnt(543, 325));
      sleep(config.sleepAnimate);

      config.run = false;
      return true;
  }
  return false;
}

function handleTryGetNextQuest() {
  if (checkIsPage(pageInQuestRoutes)){
      // Find & tap the quest
      var questFound = false
      if (!checkIsPage(pageHasQuestInMiddle) || !checkIsPage(pageHasQuestInMiddle2)) {
          handleFindNextQuest();
      }

      if (checkIsPage(pageHasQuestInMiddle)) {
          qTap(pageHasQuestInMiddle);
          sleep(config.sleepAnimate);
          questFound = true;
      } else if (checkIsPage(pageHasQuestInMiddle2)) {
          qTap(pageHasQuestInMiddle2);
          sleep(config.sleepAnimate);
          questFound = true;
      }

      console.log('=> ', questFound)

      if (questFound) {
          // Do Quest
          qTap(pnt(495, 316));
          sleep(config.sleepAnimate);

          // tap setup team
          qTap(pnt(51, 334));
          sleep(config.sleepAnimate);
          qTap(pnt(38, 316));
          sleep(config.sleepAnimate);
          qTap(pnt(614, 21));
          sleep(config.sleepAnimate);
          qTap(pnt(614, 21));
          sleep(config.sleepAnimate);
          qTap(pnt(135, 333));
          sleep(config.sleepAnimate);
          qTap(pnt(552, 325));
          sleep(config.sleepAnimate);

          //battle
          handleBattle();
          sleep(5000);

          pageGetReward = [
              {x: 353, y: 257, r: 121, g: 207, b: 12},
              {x: 353, y: 114, r: 178, g: 50, b: 32}
          ];
          for (i = 0; i < 70; i ++) {
              console.log('looking for battle reward: ', i)
              if (checkIsPage(pageGetReward)) {
                  qTap(pageGetReward)
                  break;
              }
              sleep(1000);
          }
  
      }
      return true;
  }
  return false;
}

function handleFindNextQuest() {
  // swipe to upper left
  tapDown(100, 76, 40, 0);
  sleep(config.sleep);
  moveTo(150, 150, 40, 0);
  sleep(config.sleep);
  moveTo(350, 200, 40, 0);
  sleep(config.sleep);
  moveTo(542, 277, 40, 0);
  sleep(config.sleep);
  moveTo(1500, 1500, 40, 0);
  sleep(config.sleep);
  tapUp(1500, 1500, 40, 0);
  sleep(config.sleepAnimate * 3);

  if (checkIsPage(pageHasNextQuest)) {
      qTap(pageHasNextQuest);
      sleep(config.sleepAnimate * 4);
      return true;
  } else if (checkIsPage(pageHasNextQuest2)) {
      qTap(pageHasNextQuest2);
      sleep(config.sleepAnimate * 4);
      return true;        
  }
  return false;
}

function handleUpgradeCookies() {
  pageNeedUpgradeCookies = [
      {x: 101, y: 45, r: 239, g: 116, b: 89},
      {x: 137, y: 49, r: 211, g: 66, b: 101},
      {x: 321, y: 214, r: 255, g: 243, b: 239}
  ]

  if (checkIsPage(pageNeedUpgradeCookies)) {
      console.log('handleUpgradeCookies');
      qTap(pageNeedUpgradeCookies);
      sleep(config.sleepAnimate);
      qTap(pnt(430, 324));
      qTap(pnt(394, 264));
      sleep(config.sleepAnimate * 2);
      qTap(pnt(449, 264));
      sleep(config.sleepAnimate * 2);
      qTap(pnt(557, 317));
      sleep(config.sleepAnimate * 2);
      qTap(pnt(557, 317));

      qTap(pnt(619, 20));
      qTap(pnt(619, 20));
      sleep(config.sleepAnimate);
      qTap(pnt(325, 261));
      qTap(pnt(325, 261));
      return true;
  }
  return false;
}

function handleKingdomPass() {
  pageKingdomPass = [
      {x: 586, y: 87, r: 91, g: 125, b: 159},
      {x: 374, y: 183, r: 247, g: 113, b: 183},
      {x: 514, y: 239, r: 255, g: 243, b: 239}
  ]

  if (checkIsPage(pageKingdomPass)) {
      qTap(pageKingdomPass);
      sleep(config.sleepAnimate);
      qTap(pnt(322, 286));
      sleep(config.sleepAnimate);
      qTap(pnt(620, 17));
      sleep(config.sleepAnimate);

      return true;
  }
  return false;
}

function handelStuck() {
  pageCanGotoBattleMap = [
      {x: 617, y: 326, r: 48, g: 80, b: 117},
      {x: 533, y: 316, r: 255, g: 255, b: 255},
      {x: 518, y: 24, r: 231, g: 159, b: 85}
  ]
  if (checkIsPage(pageCanGotoBattleMap)) {
      console.log('handelStuck, goto battle map');
      qTap(pageCanGotoBattleMap);
      sleep(config.sleepAnimate * 2);
      qTap(pnt(174, 180));
      return true;
  }

  // pageInMailContent = [
  //     {x: 468, y: 73, r: 56, g: 167, b: 231},
  //     {x: 356, y: 82, r: 60, g: 70, b: 105},
  //     {x: 376, y: 164, r: 243, g: 233, b: 223}
  // ]
  // if (checkIsPage(pageInMailContent)) {
  //     qTap(pageInMailContent);
  //     sleep(config.sleep);
  //     qTap(pnt(608, 23));
  //     return true;
  // }

  pageInLoginIntro = [
      {x: 296, y: 249, r: 12, g: 167, b: 223},
      {x: 345, y: 103, r: 60, g: 70, b: 105},
      {x: 391, y: 251, r: 121, g: 207, b: 12},
      {x: 418, y: 220, r: 243, g: 233, b: 223},
      {x: 596, y: 316, r: 30, g: 90, b: 4}
  ]
  if (checkIsPage(pageInLoginIntro)) {
      console.log('in visitor purchase intro page, script finished')
      qTap(pageInLoginIntro);
      sleep(config.sleep);
      qTap(pnt(607, 33));
      sleep(config.sleep);

      config.run = false;
  }

  pageCloseEmailButton = [
      {x: 618, y: 20, r: 56, g: 167, b: 231},
      {x: 530, y: 27, r: 60, g: 70, b: 105},
      {x: 572, y: 316, r: 160, g: 160, b: 160}
  ]
  if (checkIsPage(pageCloseEmailButton)) {
      console.log('not sure why stucked, but find email quit button, leaving');
      qTap(pageCloseEmailButton);
      return true;
  }
  return false;
}

function tapRandom() {
  console.log('not sure what to do, pause 0s')
  // sleep(6000)

  console.log('not in main, tap skip');
  qTap(pageSkipBtn);

  console.log('tap finish');
  qTap(pnt(320, 332));
  // qTap(pnt(322, 259));

  console.log('tap leave');
  qTap(pnt(583, 323));

  console.log('tap use skill');
  qTap(pnt(251, 323));
  qTap(pnt(380, 323));
  qTap(pnt(464, 323));
  qTap(pnt(174, 323));
}

function handleMainTaskThings() {
var handleEvents = [
  handleInitGamePage,
  handleInBattle,
  handleInputKingdomName,
  handleCloseStoryDialog,
  handleFirstBattleMisson,
  handleMakeCookie,
  handlePlayTrackCakeDog,
  handleTryGetNextQuest,
  handleUpgradeCookies,
  handleKingdomPass,
  handleBuildHouse,
];
var handleAdvanceEvents = [
  handleGetAllMails,
  handleMakeAllCookies,
]

sleep(config.sleepAnimate);
var act = false;
var img = getScreenshot();
// check whether dialog popup
for (var i = 0; i < handleEvents.length; i++) {
  console.log('try: ', handleEvents[i].name)
  handler = handleEvents[i];
  var isAct = handler(img);
  if (isAct) {
    act = true;
    releaseImage(img);
    sleep(config.sleepAnimate);
    config.chooseAccountAndLoginGame = true;
    img = getScreenshot();
  }
}

// Make all cookies
if (config.finishBattles >= 2) {
  for (var i = 0; i < handleAdvanceEvents.length; i++) {
      console.log('try: ', handleAdvanceEvents[i].name)
      handler = handleAdvanceEvents[i];
      var isAct = handler(img);
      if (isAct) {
        act = true;
        releaseImage(img);
        sleep(config.sleepAnimate);
        img = getScreenshot();
      }
    }
}

if (!act) {
  handelStuck();
}

if (!isAct && !checkIsPage(pageInVillate) && !checkIsPage(pageInQuestRoutes)) {
  console.log('handleStuck wont work, tap random');
  tapRandom();
}

releaseImage(img);
return act;
}

function start() {

  for (var i = 1; i < 1000; i++) {
      var runMain = false;
      console.log("start loop", i);

      var act = handleMainTaskThings();
      if (config.run == false) {
          console.log('jobs done!')
          break;
      }
  }
}


start();

// handleBattle();
// handleInputKingdomName();

